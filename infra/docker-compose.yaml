version: "3.8"
services:
    bb-master:
        container_name: bb-master-container
        user: bb-master:root
        build:
            context: ./bb-master
        ports:
            # Port to Try-Scheduler
            - "8031:8031"
            # Prometheus exporter (visit http://localhost:9101/metrics)
            - "9101:9101"
            # Web Frontend
            - "8010:8010"
        # Only workers must reach the workers-port,
        # hence we only expose but not publish it on the host.
        expose:
            # Workers Port
            - "9989"
        volumes:
            - "./bb-master/cfg:/home/bb-master/cfg:Z"
            - "./bb-master/compose-secrets/:/secret-volume/:Z"
        environment:
            BUILDBOT_MASTER_TITLE: "Compose"
            BUILDBOT_MASTER_TRY_PORT: "8031"
            BUILDBOT_MASTER_PORT: "9989"
            BUILDBOT_WWW_PORT: "8010"
            BUILDBOT_WWW_URL: https://localhost:8443/
        networks:
            - bb-master
            - bb-worker
        healthcheck:
            test: ["CMD", "curl", "-f", "--insecure", "https://localhost:8010"]
            interval: 1m30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # This acts as the SSL reverse proxy to buildbot
    bb-reverse-proxy:
        container_name: bb-reverse-proxy-container
        build: ./bb-reverse-proxy
        volumes:
            - "./bb-reverse-proxy/conf/nginx.conf:/etc/nginx/nginx.conf:Z"
        ports:
            - "8443:8443"
            # - "8080:8080"
        depends_on:
            - bb-master
        networks:
            - bb-master
            - bb-worker

    # Spawn 3 buildbot workers one after another
    bb-worker0:
        container_name: bb-worker-container0
        build: ./bb-worker
        environment:
            BUILDBOT_WORKER_NAME: worker0
            BUILDBOT_INFO_ADMIN: you@me.com
            BUILDBOT_MASTER: bb-master:9989
        networks:
            - bb-worker
        depends_on:
            - bb-master
        volumes:
          - "./bb-worker/compose-secrets:/secret-volume:Z"
    
    bb-worker1:
        container_name: bb-worker-container1
        build: ./bb-worker
        environment:
            BUILDBOT_WORKER_NAME: worker1
            BUILDBOT_INFO_ADMIN: you@me.com
            BUILDBOT_MASTER: bb-master:9989
        networks:
            - bb-worker
        depends_on:
            - bb-worker0
        volumes:
          - "./bb-worker/compose-secrets:/secret-volume:Z"

    bb-worker2:
        container_name: bb-worker-container2
        build: ./bb-worker
        environment:
            BUILDBOT_WORKER_NAME: worker2
            BUILDBOT_INFO_ADMIN: you@me.com
            BUILDBOT_MASTER: bb-master:9989
        networks:
            - bb-worker
        depends_on:
            - bb-worker1
        volumes:
          - "./bb-worker/compose-secrets:/secret-volume:Z"

    # Github self-hosted actions-runner
    github-runner:
        container_name: github-runner-container
        # TODO(kwk): Sadly I haven't figured out a way to get rid of this because the
        # github actions runner binary requires quite some permissions when it upgrades it self.
        # This self-upgrade cannot be stopped. 
        user: github-runner:root
        build: ./github-runner
        environment:
            # These two variables are diven by the .env file which is generated by "make prepare-secrets"
            GH_OWNER: ${GH_OWNER}
            GH_REPO: ${GH_REPO}
        networks:
            - bb-master
        depends_on:
            - bb-master
            - bb-worker1
            - bb-worker2
        volumes:
          - "./github-runner/compose-secrets:/secret-volume:Z"
networks:
    bb-master:
    bb-worker: